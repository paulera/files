#!/bin/bash

WOW=10
GOOD=50
AVER=150

bar() {
    head -c $(( $1 / 3 )) /dev/zero | tr '\0' '|'
}

function title() {
    #echo -ne "\e]0;$1\a";
    printf '\e]2;%s\a' "$1"
}


if [ -z $1 ]; then
    TARGET="google.com"
else
    TARGET=$1
fi

echo Pinging $TARGET. Ctrl+C to quit.
echo

while :; do

    if [[ "$(file $(which ping))" == *"Mach-O"* ]] || [ x"$(ping --help |& grep '\-c <count>')" != "x" ]; then
        # Apple's ping executable
        RESULT=$(ping $TARGET -c 1)
    else
        RESULT=$(ping $TARGET -n 1)
    fi

    cecho reset "\r$(now) "
    if [[ $RESULT =~ ^.*could\ not\ find\ host.*$ ]]; then
        title $TARGET" (x_x)"
        cecho red "CAN'T FIND HOST"
        cecho reset " (x_x)\n"
    elif [[ $RESULT =~ ^.*Destination\ net\ unreachable.*$ ]]; then
        cecho yellow "DESTINATION UNREACHABLE"
        cecho reset " (O.o)\n"
    elif [[ $RESULT =~ .*\ from\ .* ]]; then
        
        IP=$(echo "$RESULT" | grep " from " | awk -F"from " '{ print $2 }' | awk -F: '{ print $1 }')
        SHORTTIME=$(echo "$RESULT" | grep time= | awk -Ftime= '{ print $2 }' | awk -Fms '{ print $1 }' | awk -F\. '{ print $1 }')

        cecho white "[$IP] "

        if [ $SHORTTIME -le $WOW ]; then
            title $TARGET"=WOW"
            cecho cyan  "WOW!"
        elif [ $SHORTTIME -le $GOOD ]; then
            title $TARGET"=GOOD"
            cecho green  "GOOD"
        elif [ $SHORTTIME -le $AVER ]; then
            title $TARGET"=AVERAGE"
            cecho yellow "AVER"
        else
            title $TARGET"=SLOW"
            cecho red    "SLOW"            
        fi

        #echo -n " | "

        printf " %4s ms " $SHORTTIME

        #echo -n " | "
        
        if [ $SHORTTIME -gt 0 ]; then
            cecho cyan keep
            [ $SHORTTIME -le $WOW ] && bar $SHORTTIME || bar $WOW
        fi

        if [ $SHORTTIME -gt $WOW ]; then
            cecho green keep
            [ $SHORTTIME -le $GOOD ] && bar $SHORTTIME || bar $GOOD
        fi

        if [ $SHORTTIME -gt $GOOD ]; then
            cecho yellow keep
            [ $SHORTTIME -le $AVER ] && bar $(( $SHORTTIME - $GOOD )) || bar $AVER
        fi

        if [ $SHORTTIME -gt $AVER ]; then
            cecho red keep
            bar $(( $SHORTTIME - $AVER ))
        fi

        cecho reset "\n"
        
        sleep 0.5s

    fi
done

